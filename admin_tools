#!/usr/bin/env python3
"""
–ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–ò–í–ù–´–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ë–ê–ó–û–ô –î–ê–ù–ù–´–•
"""
import os
import sys
import logging
from config import config
from faq_data import get_faq_data

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def fill_database_manual():
    """–†—É—á–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    print("=" * 60)
    print("üõ†Ô∏è  –†–£–ß–ù–û–ï –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–•")
    print("=" * 60)
    
    try:
        # 1. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ
        conn = config.get_db_connection()
        cursor = conn.cursor()
        
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã 'faq'...")
        cursor.execute("""
            SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_name = 'faq'
            )
        """)
        table_exists = cursor.fetchone()[0]
        
        if not table_exists:
            print("‚ùå –¢–∞–±–ª–∏—Ü–∞ 'faq' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!")
            return {
                "success": False,
                "error": "–¢–∞–±–ª–∏—Ü–∞ 'faq' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç",
                "details": "–°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É —á–µ—Ä–µ–∑ SQL: CREATE TABLE faq (...)"
            }
        
        print("‚úÖ –¢–∞–±–ª–∏—Ü–∞ 'faq' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        cursor.execute("SELECT COUNT(*) FROM faq")
        count_before = cursor.fetchone()[0]
        print(f"üìä –ó–∞–ø–∏—Å–µ–π –≤ –±–∞–∑–µ –¥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è: {count_before}")
        
        # 4. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ faq_data.py
        print("üìö –ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ faq_data.py...")
        faq_list = get_faq_data()
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(faq_list)} –≤–æ–ø—Ä–æ—Å–æ–≤")
        
        # 5. –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        print("üßπ –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã...")
        cursor.execute("TRUNCATE TABLE faq RESTART IDENTITY CASCADE")
        
        # 6. –í—Å—Ç–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        print("üìù –í—Å—Ç–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –±–∞–∑—É...")
        inserted = 0
        errors = []
        
        for idx, faq in enumerate(faq_list, 1):
            try:
                sql = """
                INSERT INTO faq (question, answer, keywords, norm_keywords, norm_question, category)
                VALUES (%s, %s, %s, %s, %s, %s)
                """
                cursor.execute(sql, (
                    faq['question'],
                    faq['answer'],
                    faq['keywords'],
                    faq['norm_keywords'],
                    faq['norm_question'],
                    faq['category']
                ))
                inserted += 1
                
                if idx % 10 == 0:
                    print(f"   –î–æ–±–∞–≤–ª–µ–Ω–æ {idx} –∏–∑ {len(faq_list)} –≤–æ–ø—Ä–æ—Å–æ–≤...")
                    
            except Exception as e:
                errors.append({
                    "index": idx,
                    "question": faq['question'][:50],
                    "error": str(e)
                })
                print(f"   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞ {idx}: {e}")
        
        # 7. –§–∏–∫—Å–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        conn.commit()
        
        # 8. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        cursor.execute("SELECT COUNT(*) FROM faq")
        count_after = cursor.fetchone()[0]
        
        cursor.execute("SELECT COUNT(DISTINCT category) FROM faq")
        categories_count = cursor.fetchone()[0]
        
        conn.close()
        
        # 9. –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result = {
            "success": True,
            "stats": {
                "total_questions": len(faq_list),
                "inserted": inserted,
                "errors": len(errors),
                "final_count": count_after,
                "categories": categories_count,
                "before": count_before,
                "after": count_after
            },
            "details": {
                "expected": 75,
                "actual": count_after,
                "completion": f"{(count_after/75*100):.1f}%"
            }
        }
        
        if errors:
            result["error_details"] = errors[:5]  # –ü–µ—Ä–≤—ã–µ 5 –æ—à–∏–±–æ–∫
        
        print("=" * 60)
        print(f"‚úÖ –£–°–ü–ï–•: –î–æ–±–∞–≤–ª–µ–Ω–æ {inserted} –≤–æ–ø—Ä–æ—Å–æ–≤")
        print(f"üìä –í—Å–µ–≥–æ –≤ –±–∞–∑–µ: {count_after} –∑–∞–ø–∏—Å–µ–π")
        print(f"üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏–π: {categories_count}")
        
        if errors:
            print(f"‚ö†Ô∏è  –û—à–∏–±–æ–∫ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: {len(errors)}")
        
        return result
        
    except Exception as e:
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        import traceback
        traceback.print_exc()
        return {
            "success": False,
            "error": str(e),
            "traceback": traceback.format_exc()
        }

def check_database_status():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    try:
        conn = config.get_db_connection()
        cursor = conn.cursor()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        cursor.execute("""
            SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_name = 'faq'
            )
        """)
        table_exists = cursor.fetchone()[0]
        
        if not table_exists:
            return {
                "table_exists": False,
                "error": "–¢–∞–±–ª–∏—Ü–∞ 'faq' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            }
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        cursor.execute("SELECT COUNT(*) FROM faq")
        total_count = cursor.fetchone()[0]
        
        cursor.execute("SELECT COUNT(DISTINCT category) FROM faq")
        categories = cursor.fetchone()[0]
        
        cursor.execute("SELECT category, COUNT(*) as count FROM faq GROUP BY category ORDER BY count DESC")
        category_stats = cursor.fetchall()
        
        cursor.execute("SELECT question FROM faq LIMIT 5")
        sample_questions = [row[0][:50] + "..." for row in cursor.fetchall()]
        
        conn.close()
        
        return {
            "table_exists": True,
            "total_records": total_count,
            "categories_count": categories,
            "expected_records": 75,
            "completion_percentage": f"{(total_count/75*100):.1f}%",
            "category_stats": [{"category": cat, "count": cnt} for cat, cnt in category_stats],
            "sample_questions": sample_questions,
            "status": "complete" if total_count >= 75 else "partial" if total_count > 0 else "empty"
        }
        
    except Exception as e:
        return {
            "error": str(e),
            "table_exists": False
        }

if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫ –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    print("üîß –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
    print("1. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö")
    print("2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–∞–∑—ã")
    
    choice = input("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ (1 –∏–ª–∏ 2): ").strip()
    
    if choice == "1":
        result = fill_database_manual()
        print(f"\n–†–µ–∑—É–ª—å—Ç–∞—Ç: {result}")
    elif choice == "2":
        status = check_database_status()
        print(f"\n–°—Ç–∞—Ç—É—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {status}")
    else:
        print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä")
