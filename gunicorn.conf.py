"""
Gunicorn конфигурация для Render Free
Версия 9.3.3 - Ручная настройка для гарантии работы
"""

import os
import multiprocessing

# ======================
# ОСНОВНЫЕ НАСТРОЙКИ
# ======================

# Порт для привязки (Render передает через PORT)
bind = f"0.0.0.0:{os.getenv('PORT', '10000')}"

# Количество воркеров (1 для бесплатного тарифа Render)
workers = 1

# Количество потоков на воркер
threads = 2

# ======================
# ТАЙМАУТЫ И ПРОИЗВОДИТЕЛЬНОСТЬ
# ======================

# Таймаут запроса (Render health check timeout 30s + запас)
timeout = 60

# Время keep-alive соединения
keepalive = 5

# Graceful timeout для завершения воркеров
graceful_timeout = 30

# ======================
# ЛОГИРОВАНИЕ
# ======================

# Уровень логирования
loglevel = os.getenv('GUNICORN_LOG_LEVEL', 'info')

# Вывод access логов в stdout (Render захватывает stdout)
accesslog = '-'

# Вывод error логов в stderr
errorlog = '-'

# Захватывать вывод приложения
capture_output = True

# Формат логов
access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s"'

# ======================
# РЕЖИМ РАБОТЫ И ОПТИМИЗАЦИЯ
# ======================

# Класс воркеров (sync для простоты и стабильности)
worker_class = 'sync'

# Не запускать как демон (Render управляет процессом)
daemon = False

# Перезагрузка при изменениях (только для разработки)
reload = False

# ======================
# ОГРАНИЧЕНИЯ ПАМЯТИ И ПЕРЕЗАПУСКИ
# ======================

# Перезапуск воркера после N запросов (предотвращение утечек памяти)
max_requests = 1000

# Случайный разброс для избежания одновременных перезапусков
max_requests_jitter = 50

# ======================
# ОПТИМИЗАЦИЯ ЗАПУСКА
# ======================

# Preload приложения для экономии памяти и ускорения запуска
preload_app = True

# ======================
# БЕЗОПАСНОСТЬ
# ======================

# Ограничение размера заголовков
limit_request_line = 4096
limit_request_fields = 100
limit_request_field_size = 8190

# ======================
# РАСШИРЕННЫЕ НАСТРОЙКИ
# ======================

# User/group для запуска (оставляем по умолчанию)
# user = 'nobody'
# group = 'nobody'

# Рабочая директория
chdir = os.path.dirname(os.path.abspath(__file__))

# Путь к файлу с PID (для управления процессом)
pidfile = None  # Render управляет процессами самостоятельно

# ======================
# ЗАПУСК
# ======================

if __name__ == '__main__':
    print(f"✅ Gunicorn конфигурация загружена (версия 9.3.3)")
    print(f"   Привязка: {bind}")
    print(f"   Воркеры: {workers}")
    print(f"   Потоки: {threads}")
    print(f"   Таймаут: {timeout} сек")
    print(f"   Preload: {preload_app}")
    print(f"   Max requests: {max_requests}")