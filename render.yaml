services:
  - type: web
    name: hr-bot-mechel
    env: python
    region: frankfurt
    plan: free
    autoDeploy: true
    buildCommand: |
      echo "========================================================"
      echo "üöÄ –ù–ê–ß–ê–õ–û –°–ë–û–†–ö–ò HR-–ë–û–¢–ê –ú–ï–ß–ï–õ"
      echo "========================================================"
      
      echo ""
      echo "üîß –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô"
      echo "========================================================"
      pip install --upgrade pip
      pip install -r requirements.txt
      
      echo ""
      echo "üóÑÔ∏è  –ü–†–û–í–ï–†–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö POSTGRESQL"
      echo "========================================================"
      python -c "
      import sys
      sys.path.insert(0, '.')
      from config import config
      try:
          conn = config.get_db_connection()
          cur = conn.cursor()
          cur.execute('SELECT version()')
          version = cur.fetchone()[0]
          conn.close()
          print(f'‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL —É—Å–ø–µ—à–Ω–æ')
          print(f'   –í–µ—Ä—Å–∏—è: {version.split(',')[0]}')
      except Exception as e:
          print(f'‚ùå –û–®–ò–ë–ö–ê –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: {e}')
          sys.exit(1)
      "
      
      echo ""
      echo "üîç –ü–†–û–í–ï–†–ö–ê –°–¢–†–£–ö–¢–£–†–´ –ë–ê–ó–´ –î–ê–ù–ù–´–•"
      echo "========================================================"
      python -c "
      import sys
      sys.path.insert(0, '.')
      from config import config
      try:
          conn = config.get_db_connection()
          cur = conn.cursor()
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã faq
          cur.execute('''
              SELECT EXISTS (
                  SELECT FROM information_schema.tables 
                  WHERE table_schema = 'public' 
                  AND table_name = 'faq'
              )
          ''')
          table_exists = cur.fetchone()[0]
          
          if table_exists:
              print('‚úÖ –¢–∞–±–ª–∏—Ü–∞ \"faq\" —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã
              cur.execute('''
                  SELECT column_name, data_type 
                  FROM information_schema.columns 
                  WHERE table_name = 'faq' 
                  ORDER BY ordinal_position
              ''')
              columns = cur.fetchall()
              print(f'   –°—Ç–æ–ª–±—Ü—ã —Ç–∞–±–ª–∏—Ü—ã:')
              for col_name, col_type in columns:
                  print(f'   - {col_name} ({col_type})')
          else:
              print('‚ùå –¢–∞–±–ª–∏—Ü–∞ \"faq\" –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!')
              print('   –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ create_database.py')
              # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
              print('   –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã...')
              from faq_data import get_faq_data
              cur.execute('''
                  CREATE TABLE IF NOT EXISTS faq (
                      id SERIAL PRIMARY KEY,
                      question TEXT NOT NULL,
                      answer TEXT NOT NULL,
                      keywords TEXT,
                      norm_keywords TEXT,
                      norm_question TEXT,
                      category TEXT,
                      usage_count INTEGER DEFAULT 0,
                      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                  )
              ''')
              print('   ‚úÖ –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞')
          
          conn.close()
      except Exception as e:
          print(f'‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î: {e}')
          # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Å–±–æ—Ä–∫—É, –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
      "
      
      echo ""
      echo "üìù –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–• 75 –í–û–ü–†–û–°–ê–ú–ò"
      echo "========================================================"
      python -c "
      import sys
      sys.path.insert(0, '.')
      from config import config
      from faq_data import get_faq_data
      import traceback
      
      try:
          print('üìö –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ faq_data.py...')
          faq_list = get_faq_data()
          print(f'‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(faq_list)} –≤–æ–ø—Ä–æ—Å–æ–≤')
          
          conn = config.get_db_connection()
          cur = conn.cursor()
          
          # –°—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
          cur.execute('SELECT COUNT(*) FROM faq')
          count_before = cur.fetchone()[0]
          print(f'üìä –ó–∞–ø–∏—Å–µ–π –≤ –±–∞–∑–µ –¥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è: {count_before}')
          
          if count_before >= 75:
              print('‚úÖ –ë–∞–∑–∞ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–ø–∏—Å–µ–π. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ.')
              conn.close()
          else:
              print('üßπ –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã...')
              cur.execute('TRUNCATE TABLE faq RESTART IDENTITY CASCADE')
              
              print('üìù –í—Å—Ç–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤...')
              inserted = 0
              for faq in faq_list:
                  sql = '''
                  INSERT INTO faq (question, answer, keywords, norm_keywords, norm_question, category)
                  VALUES (%s, %s, %s, %s, %s, %s)
                  '''
                  cur.execute(sql, (
                      faq['question'],
                      faq['answer'],
                      faq['keywords'],
                      faq['norm_keywords'],
                      faq['norm_question'],
                      faq['category']
                  ))
                  inserted += 1
                  
                  if inserted % 10 == 0:
                      print(f'   –î–æ–±–∞–≤–ª–µ–Ω–æ {inserted} –≤–æ–ø—Ä–æ—Å–æ–≤...')
              
              conn.commit()
              conn.close()
              print(f'‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ {inserted} –≤–æ–ø—Ä–æ—Å–æ–≤')
              
      except Exception as e:
          print(f'‚ùå –û–®–ò–ë–ö–ê –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}')
          traceback.print_exc()
          # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Å–±–æ—Ä–∫—É - –±–æ—Ç –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø—É—Å—Ç–æ–π/—á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –±–∞–∑–æ–π
      "
      
      echo ""
      echo "üîç –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•"
      echo "========================================================"
      python -c "
      import sys
      sys.path.insert(0, '.')
      from config import config
      
      try:
          conn = config.get_db_connection()
          cur = conn.cursor()
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
          cur.execute('SELECT COUNT(*) FROM faq')
          total_count = cur.fetchone()[0]
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
          cur.execute('SELECT COUNT(DISTINCT category) FROM faq')
          category_count = cur.fetchone()[0]
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤
          cur.execute('SELECT COUNT(DISTINCT norm_question) FROM faq')
          unique_count = cur.fetchone()[0]
          
          conn.close()
          
          print('üìä –†–ï–ó–£–õ–¨–¢–ê–¢ –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•:')
          print(f'   ‚Ä¢ –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {total_count}')
          print(f'   ‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π: {category_count}')
          print(f'   ‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: {unique_count}')
          
          if total_count >= 75:
              print('‚úÖ –£–°–ü–ï–•: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!')
          elif total_count > 0:
              print(f'‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í –±–∞–∑–µ —Ç–æ–ª—å–∫–æ {total_count} –∏–∑ 75 –∑–∞–ø–∏—Å–µ–π')
              print('   –ë–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π')
          else:
              print('‚ùå –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞—è!')
              print('   –ë–æ—Ç –Ω–µ —Å–º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã')
              
      except Exception as e:
          print(f'‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}')
      "
      
      echo ""
      echo "üß™ –ü–†–û–í–ï–†–ö–ê –ö–û–†–†–ï–ö–¢–ù–û–°–¢–ò –ö–û–î–ê"
      echo "========================================================"
      python -c "
      import sys
      sys.path.insert(0, '.')
      
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
      try:
          from config import config
          print('‚úÖ config.py –∑–∞–≥—Ä—É–∂–µ–Ω')
      except Exception as e:
          print(f'‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ config.py: {e}')
      
      try:
          from faq_data import get_faq_data
          print('‚úÖ faq_data.py –∑–∞–≥—Ä—É–∂–µ–Ω')
      except Exception as e:
          print(f'‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ faq_data.py: {e}')
      
      try:
          from search_engine import SearchEngine
          print('‚úÖ search_engine.py –∑–∞–≥—Ä—É–∂–µ–Ω')
      except Exception as e:
          print(f'‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ search_engine.py: {e}')
      
      try:
          from handlers import CommandHandler
          print('‚úÖ handlers.py –∑–∞–≥—Ä—É–∂–µ–Ω')
      except Exception as e:
          print(f'‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ handlers.py: {e}')
      
      print('‚úÖ –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ')
      "
      
      echo ""
      echo "========================================================"
      echo "üéâ –°–ë–û–†–ö–ê –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê"
      echo "========================================================"
    startCommand: python bot.py
    envVars:
      - key: BOT_TOKEN
        sync: false
        required: true
      - key: ADMIN_IDS
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: MEME_ENABLED
        value: "false"
      - key: FEEDBACK_ENABLED
        value: "true"
      - key: AUTO_SET_WEBHOOK
        value: "true"
      - key: RENDER_EXTERNAL_URL
        fromService:
          name: hr-bot-mechel
          type: web
          property: url
      - key: PORT
        value: "10000"
    healthCheckPath: /health
    healthCheckInterval: 60
